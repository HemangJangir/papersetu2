{% extends 'dashboard/dashboard.html' %}
{% load dashboard_extras %}
{% load static %}
{% block nav %}{{ block.super }}{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Invite Subreviewers</h1>
        <p class="text-gray-600">Manage subreviewer invitations for papers in {{ conference.acronym|default:conference.name }}</p>
    </div>

    <!-- Track Information Banner -->
    {% if user_track %}
    <div class="bg-blue-50 border-l-4 border-blue-400 rounded-lg p-6 mb-8">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-400 text-xl"></i>
            </div>
            <div class="ml-3">
                <p class="text-blue-800 font-medium">
                    You are viewing papers filtered by your assigned track: 
                    <span class="font-bold">{{ user_track.name }} ({{ user_track.track_id }})</span>
                </p>
            </div>
        </div>
    </div>
    {% elif is_pc_member %}
    <div class="bg-green-50 border-l-4 border-green-400 rounded-lg p-6 mb-8">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-green-400 text-xl"></i>
            </div>
            <div class="ml-3">
                <p class="text-green-800 font-medium">
                    You can view and assign subreviewers to papers from all tracks (no specific track assigned)
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Success/Error Messages -->
    {% if message %}
        {% if message_type == 'success' %}
            <div class="mb-8 bg-green-50 border-l-4 border-green-400 rounded-lg p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-green-400 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-green-800 font-medium whitespace-pre-line">{{ message }}</p>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="mb-8 bg-red-50 border-l-4 border-red-400 rounded-lg p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-400 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-red-800 font-medium whitespace-pre-line">{{ message }}</p>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}

    <!-- Single Invite Form -->
    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-user-plus text-blue-600 mr-3"></i>
            Send Single Invitation
        </h2>
        
        <form method="post" class="space-y-6" id="singleInviteForm">
            {% csrf_token %}
            <input type="hidden" name="action" value="invite">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Paper Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-file-alt text-gray-500 mr-2"></i>
                        Select Paper Title
                    </label>
                    <select name="paper_id" id="paperTitleSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" required>
                        <option value="">Choose a paper...</option>
                        {% for paper in papers %}
                            <option value="{{ paper.id }}" data-paper-id="{{ paper.paper_id }}" data-track-id="{{ paper.track.id|default:'' }}">{{ paper.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Paper ID Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-hashtag text-gray-500 mr-2"></i>
                        Select Paper ID
                    </label>
                    <select name="paper_id_input" id="paperIdSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" required>
                        <option value="">Choose a paper ID...</option>
                        {% for paper in papers %}
                            <option value="{{ paper.paper_id }}" data-paper-title="{{ paper.title }}">{{ paper.paper_id }}</option>
                        {% endfor %}
                    </select>
                    <div id="paperIdError" class="text-red-500 text-sm mt-1 hidden">Paper ID does not match the selected paper title.</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Track Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-tag text-gray-500 mr-2"></i>
                        Select Track (Optional)
                    </label>
                    <select name="track" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        <option value="">Choose a track...</option>
                        {% for track in tracks %}
                            <option value="{{ track.id }}">{{ track.name }} ({{ track.track_id }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Subreviewer Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user text-gray-500 mr-2"></i>
                        Select Subreviewer
                    </label>
                    <select name="user_id" id="singleUserSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        <option value="">Choose a subreviewer...</option>
                        {% for user in all_users %}
                            <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }} ({{ user.email }})</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Email Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope text-gray-500 mr-2"></i>
                        Subreviewer Email
                    </label>
                    <input type="email" name="email" placeholder="Enter email address" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" required>
                </div>
            </div>

            <!-- Invitation Message -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-comment text-gray-500 mr-2"></i>
                    Invitation Message
                </label>
                <textarea name="template_body" 
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" 
                          rows="4">{{ default_template }}</textarea>
            </div>

            <div class="flex justify-end">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition duration-200 flex items-center">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Send Invitation
                </button>
            </div>
        </form>
    </div>

    <!-- Bulk Invite Section -->
    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-users text-green-600 mr-3"></i>
            Bulk Invite Subreviewers
        </h2>
        
        <form method="post" id="bulkInviteForm" class="space-y-6">
            {% csrf_token %}
            <input type="hidden" name="action" value="bulk_invite">
            
            <!-- Paper and Track Selection for Bulk -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-file-alt text-gray-500 mr-2"></i>
                        Select Paper for Bulk Invitation
                    </label>
                    <select name="paper_id" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" required>
                        <option value="">Choose a paper...</option>
                        {% for paper in papers %}
                            <option value="{{ paper.id }}">{{ paper.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-tag text-gray-500 mr-2"></i>
                        Select Track (Optional)
                    </label>
                    <select name="track" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        <option value="">Choose a track...</option>
                        {% for track in tracks %}
                            <option value="{{ track.id }}">{{ track.name }} ({{ track.track_id }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Users Table -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    <i class="fas fa-user-check text-gray-500 mr-2"></i>
                    Select Users to Invite
                </label>
                <div class="bg-gray-50 rounded-lg p-4 max-h-64 overflow-y-auto">
                    <table class="min-w-full">
                        <thead class="bg-white sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for user in all_users %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    <input type="checkbox" class="bulk-user-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                                           data-user-id="{{ user.id }}" 
                                           data-user-name="{{ user.get_full_name|default:user.username }}" 
                                           data-user-email="{{ user.email }}">
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-900">{{ user.get_full_name|default:user.username }}</td>
                                <td class="px-4 py-3 text-sm text-gray-500">{{ user.email }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Bulk Invitation List -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-list text-gray-500 mr-2"></i>
                    Bulk Invitation List
                </label>
                <textarea id="bulkInvitationList" name="bulk_invitation_list" 
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" 
                          rows="4" 
                          placeholder="Format: Name <email>&#10;One per line. You can edit or paste here."></textarea>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    You can select users above or paste/edit the list here. Format: <code class="bg-gray-100 px-1 rounded">Name &lt;email&gt;</code> per line.
                </p>
            </div>

            <div class="flex justify-end">
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition duration-200 flex items-center">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Send Bulk Invitations
                </button>
            </div>
        </form>
    </div>

    <!-- Invitations History -->
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-history text-purple-600 mr-3"></i>
            All Subreviewer Invitations
        </h2>
        
        {% if invites %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submission</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subreviewer</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PC Member</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Responded</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for invite in invites %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">{{ invite.paper.title }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">{{ invite.subreviewer.get_full_name|default:invite.subreviewer.username }}</div>
                            <div class="text-sm text-gray-500">{{ invite.email }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">{{ invite.invited_by.get_full_name|default:invite.invited_by.username }}</div>
                        </td>
                        <td class="px-6 py-4">
                            {% if invite.status == 'accepted' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check mr-1"></i>Accepted
                                </span>
                            {% elif invite.status == 'declined' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    <i class="fas fa-times mr-1"></i>Declined
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-clock mr-1"></i>Pending
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">{{ invite.requested_at|date:'M d, Y H:i' }}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">{{ invite.responded_at|date:'M d, Y H:i'|default:'-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i>
            <p class="text-gray-500 text-lg">No subreviewer invitations yet.</p>
            <p class="text-gray-400 text-sm mt-2">Start by sending invitations using the forms above.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Bulk invitation logic
const checkboxes = document.querySelectorAll('.bulk-user-checkbox');
const bulkList = document.getElementById('bulkInvitationList');
const selectAllCheckbox = document.getElementById('selectAll');
let selectedUsers = [];

// Select all functionality
selectAllCheckbox.addEventListener('change', function() {
    checkboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
        cb.dispatchEvent(new Event('change'));
    });
});

// Individual checkbox functionality
checkboxes.forEach(cb => {
    cb.addEventListener('change', function() {
        const user = {
            id: cb.getAttribute('data-user-id'),
            name: cb.getAttribute('data-user-name'),
            email: cb.getAttribute('data-user-email')
        };
        
        if (cb.checked) {
            selectedUsers.push(user);
        } else {
            selectedUsers = selectedUsers.filter(u => u.id !== user.id);
        }
        
        // Update select all checkbox
        const checkedCount = document.querySelectorAll('.bulk-user-checkbox:checked').length;
        selectAllCheckbox.checked = checkedCount === checkboxes.length;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        
        // Update bulk list
        bulkList.value = selectedUsers.map(u => `${u.name} <${u.email}>`).join('\n');
    });
});

// Paper ID validation
const paperTitleSelect = document.getElementById('paperTitleSelect');
const paperIdSelect = document.getElementById('paperIdSelect');
const paperIdError = document.getElementById('paperIdError');
const submitButton = document.querySelector('button[type="submit"]');

function validatePaperId() {
    const selectedTitleOption = paperTitleSelect.options[paperTitleSelect.selectedIndex];
    const selectedIdOption = paperIdSelect.options[paperIdSelect.selectedIndex];
    
    if (selectedTitleOption.value && selectedIdOption.value) {
        const expectedPaperId = selectedTitleOption.getAttribute('data-paper-id');
        const selectedPaperId = selectedIdOption.value;
        
        if (expectedPaperId === selectedPaperId) {
            paperIdError.classList.add('hidden');
            paperIdSelect.classList.remove('border-red-500');
            paperIdSelect.classList.add('border-green-500');
            submitButton.disabled = false;
        } else {
            paperIdError.classList.remove('hidden');
            paperIdSelect.classList.add('border-red-500');
            paperIdSelect.classList.remove('border-green-500');
            submitButton.disabled = true;
        }
    } else {
        paperIdError.classList.add('hidden');
        paperIdSelect.classList.remove('border-red-500', 'border-green-500');
        submitButton.disabled = false;
    }
}

function updatePaperIdOptions() {
    const selectedTrack = document.querySelector('select[name="track"]').value;
    const paperIdSelect = document.getElementById('paperIdSelect');
    
    // Clear current options
    paperIdSelect.innerHTML = '<option value="">Choose a paper ID...</option>';
    
    // Get all paper options
    const paperOptions = document.querySelectorAll('#paperTitleSelect option[data-paper-id]');
    
    paperOptions.forEach(option => {
        const paperId = option.getAttribute('data-paper-id');
        const paperTitle = option.textContent;
        const paperTrack = option.getAttribute('data-track-id') || '';
        
        // If track is selected, only show papers from that track
        if (!selectedTrack || paperTrack === selectedTrack) {
            const newOption = document.createElement('option');
            newOption.value = paperId;
            newOption.textContent = paperId;
            newOption.setAttribute('data-paper-title', paperTitle);
            paperIdSelect.appendChild(newOption);
        }
    });
    
    validatePaperId();
}

paperTitleSelect.addEventListener('change', validatePaperId);
paperIdSelect.addEventListener('change', validatePaperId);
document.querySelector('select[name="track"]').addEventListener('change', updatePaperIdOptions);
</script>
{% endblock %} 